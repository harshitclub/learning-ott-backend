generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
  output        = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  emailVerified     Boolean   @default(false)
  passwordHash      String
  firstName         String
  lastName          String
  username          String?   @unique
  phone             String?
  isDisabled        Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  profile           Json?
  role              Role      @default(USER)
  lastLoginAt       DateTime?
  failedLogins      Int       @default(0)
  passwordChangedAt DateTime?
  metadata          Json?

  // verification / reset tokens (hashed)
  emailVerificationTokenHash String? // SHA256 hash of verification token
  emailVerificationExpiresAt DateTime? // expiry for verification token
  emailVerificationUsed      Boolean   @default(false)

  passwordResetTokenHash String? // SHA256 hash of reset token
  passwordResetExpiresAt DateTime?
  passwordResetUsed      Boolean   @default(false)

  // relations
  refreshTokens UserRefreshToken[]

  @@index([email])
  @@index([createdAt])
  @@index([emailVerificationExpiresAt])
  @@index([passwordResetExpiresAt])
}

model Admin {
  id            String    @id @default(uuid())
  firstName     String
  lastName      String
  email         String    @unique
  emailVerified Boolean   @default(false)
  passwordHash  String
  username      String?   @unique
  phone         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  role          Role      @default(ADMIN)
  isSuperAdmin  Boolean   @default(false)
  notes         String?
  lastLoginAt   DateTime?
  metadata      Json?

  // verification / reset tokens (hashed)
  emailVerificationTokenHash String?
  emailVerificationExpiresAt DateTime?
  emailVerificationUsed      Boolean   @default(false)

  passwordResetTokenHash String?
  passwordResetExpiresAt DateTime?
  passwordResetUsed      Boolean             @default(false)
  AdminRefreshToken      AdminRefreshToken[]

  @@index([email])
  @@index([createdAt])
  @@index([emailVerificationExpiresAt])
  @@index([passwordResetExpiresAt])
}

model UserRefreshToken {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash  String   @unique
  deviceId   String?
  ip         String?
  userAgent  String?
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  revoked    Boolean  @default(false)
  replacedBy String?

  @@index([userId])
  @@index([expiresAt])
}

model AdminRefreshToken {
  id         String   @id @default(uuid())
  adminId    String
  admin      Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)
  tokenHash  String   @unique
  deviceId   String?
  ip         String?
  userAgent  String?
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  revoked    Boolean  @default(false)
  replacedBy String?

  @@index([adminId])
  @@index([expiresAt])
}
